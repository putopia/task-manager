<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>„Çø„Çπ„ÇØÁÆ°ÁêÜ</title>
<link rel="apple-touch-icon" href="https://fav.farm/üçÅ">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #F4F1EC;
    --surface: #FFFFFF;
    --ink: #1C1917;
    --ink-muted: #78716C;
    --accent: #C84B31;
    --high: #C84B31;
    --mid: #D97706;
    --low: #4B7C59;
    --done: #A8A29E;
    --prog: #2563EB;
    --border: #E7E2D9;
    --shadow: 0 2px 12px rgba(0,0,0,0.07);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Noto Sans JP', sans-serif; background: var(--bg); color: var(--ink); min-height: 100vh; }

  header {
    background: var(--ink); color: #fff;
    padding: 16px 20px; position: sticky; top: 0; z-index: 50;
    display: flex; align-items: center; justify-content: space-between;
  }
  .header-sub { font-size: 11px; opacity: .45; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 2px; }
  .header-title { font-family: 'DM Serif Display', serif; font-size: 22px; }
  .view-tabs { display: flex; gap: 4px; }
  .view-tab {
    padding: 6px 14px; border-radius: 20px; border: none; cursor: pointer;
    font-size: 13px; font-weight: 700; font-family: 'Noto Sans JP', sans-serif;
    background: transparent; color: rgba(255,255,255,.5); transition: all .2s;
  }
  .view-tab.active { background: #fff; color: var(--ink); }

  /* Filter bar */
  .filter-bar {
    padding: 10px 16px; background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex; gap: 8px; overflow-x: auto;
    scrollbar-width: none;
  }
  .filter-bar::-webkit-scrollbar { display: none; }
  .filter-chip {
    flex-shrink: 0; padding: 5px 14px; border-radius: 20px;
    border: 1.5px solid var(--border); background: var(--bg);
    font-size: 12px; font-weight: 700; cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif; color: var(--ink-muted);
    transition: all .15s; white-space: nowrap;
  }
  .filter-chip.active { border-color: transparent; color: #fff; }

  main { padding: 20px 16px 100px; max-width: 640px; margin: 0 auto; }

  /* Week grid */
  .week-grid {
    display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;
    margin-bottom: 24px; background: var(--surface);
    border-radius: 16px; padding: 16px 12px; box-shadow: var(--shadow);
  }
  .day-col { text-align: center; }
  .day-label { font-size: 10px; color: var(--ink-muted); margin-bottom: 6px; font-weight: 700; letter-spacing: 1px; }
  .day-label.weekend { color: var(--accent); }
  .day-num {
    width: 32px; height: 32px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; margin: 0 auto 6px; border: 1px solid var(--border);
  }
  .day-num.today { background: var(--ink); color: #fff; border-color: var(--ink); font-weight: 700; }
  .day-dots { display: flex; flex-direction: column; gap: 2px; }
  .day-dot {
    font-size: 8px; padding: 2px 3px; border-radius: 3px; color: #fff;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer;
  }

  .section-label {
    font-size: 11px; font-weight: 700; letter-spacing: 2px;
    text-transform: uppercase; color: var(--ink-muted);
    margin-bottom: 10px; margin-top: 20px;
  }

  .task-list { display: flex; flex-direction: column; gap: 8px; }
  .task-card {
    background: var(--surface); border-radius: 14px; padding: 14px;
    display: flex; align-items: center; gap: 12px;
    box-shadow: var(--shadow); border: 1.5px solid transparent; transition: border-color .2s;
  }
  .task-card.overdue { border-color: var(--accent); }
  .task-card.done-card { opacity: .55; }

  .progress-btn {
    width: 36px; height: 36px; border-radius: 50%; border: none;
    cursor: pointer; flex-shrink: 0; display: flex; align-items: center;
    justify-content: center; font-size: 14px; color: #fff; transition: transform .15s;
  }
  .progress-btn:active { transform: scale(.92); }

  .task-body { flex: 1; min-width: 0; }
  .task-name { font-size: 15px; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .task-name.done-name { text-decoration: line-through; opacity: .6; }
  .task-meta { display: flex; gap: 6px; margin-top: 5px; align-items: center; flex-wrap: wrap; }

  .badge { font-size: 10px; padding: 2px 8px; border-radius: 10px; color: #fff; font-weight: 700; }
  .tag-badge { font-size: 10px; padding: 2px 10px; border-radius: 10px; font-weight: 700; }

  .deadline-text { font-size: 12px; color: var(--ink-muted); }
  .deadline-text.overdue { color: var(--accent); font-weight: 700; }
  .progress-text { font-size: 11px; color: var(--ink-muted); }

  .edit-btn { background: none; border: none; cursor: pointer; color: var(--border); font-size: 22px; padding: 4px; transition: color .2s; }
  .edit-btn:hover { color: var(--ink-muted); }

  .empty { text-align: center; padding: 40px 0; color: var(--ink-muted); font-size: 14px; }

  .fab {
    position: fixed; bottom: 28px; right: 20px;
    width: 56px; height: 56px; border-radius: 50%;
    background: var(--ink); color: #fff; border: none; font-size: 28px;
    cursor: pointer; box-shadow: 0 4px 20px rgba(0,0,0,.25);
    display: flex; align-items: center; justify-content: center;
    transition: transform .15s; z-index: 40;
  }
  .fab:active { transform: scale(.93); }

  /* Modal */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,.45);
    display: none; align-items: flex-end; z-index: 100;
    opacity: 0; transition: opacity .25s;
  }
  .modal-overlay.open { opacity: 1; }
  .modal {
    background: var(--surface); width: 100%; border-radius: 20px 20px 0 0;
    padding: 24px 20px 40px; max-height: 90vh; overflow-y: auto;
    transform: translateY(100%); transition: transform .3s cubic-bezier(.32,1,.23,1);
  }
  .modal-overlay.open .modal { transform: translateY(0); }
  .modal-title { font-family: 'DM Serif Display', serif; font-size: 22px; margin-bottom: 20px; }

  label { display: block; font-size: 11px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: var(--ink-muted); margin-bottom: 6px; }
  input[type="text"], input[type="date"] {
    width: 100%; padding: 12px 14px; border-radius: 10px;
    border: 1.5px solid var(--border); font-size: 15px; margin-bottom: 16px;
    font-family: 'Noto Sans JP', sans-serif; background: var(--bg); outline: none;
    transition: border-color .2s;
  }
  input[type="text"]:focus, input[type="date"]:focus { border-color: var(--ink); }

  .toggle-group { display: flex; gap: 8px; margin-bottom: 16px; }
  .toggle-btn {
    flex: 1; padding: 10px 0; border-radius: 10px; border: 1.5px solid var(--border);
    background: var(--bg); color: var(--ink-muted); font-weight: 700; font-size: 13px;
    cursor: pointer; font-family: 'Noto Sans JP', sans-serif; transition: all .15s;
  }
  .toggle-btn.selected { color: #fff; border-color: transparent; }

  /* Tag selector in form */
  .tag-select-list { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
  .tag-select-item {
    padding: 6px 14px; border-radius: 20px; border: 1.5px solid var(--border);
    font-size: 12px; font-weight: 700; cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif; transition: all .15s;
  }
  .tag-select-item.selected { color: #fff; border-color: transparent; }
  .tag-select-none {
    padding: 6px 14px; border-radius: 20px; border: 1.5px solid var(--border);
    font-size: 12px; font-weight: 700; cursor: pointer; color: var(--ink-muted);
    background: var(--bg); font-family: 'Noto Sans JP', sans-serif;
  }
  .tag-select-none.selected { background: var(--ink); color: #fff; border-color: var(--ink); }

  .btn-primary {
    width: 100%; padding: 16px; background: var(--ink); color: #fff;
    border: none; border-radius: 14px; font-weight: 700; font-size: 16px;
    cursor: pointer; font-family: 'Noto Sans JP', sans-serif; margin-bottom: 10px;
  }
  .btn-danger {
    width: 100%; padding: 14px; background: #fff; color: var(--accent);
    border: 1.5px solid var(--accent); border-radius: 14px; font-weight: 700; font-size: 15px;
    cursor: pointer; font-family: 'Noto Sans JP', sans-serif; margin-bottom: 10px;
  }
  .btn-cancel {
    width: 100%; padding: 14px; background: var(--bg); color: var(--ink-muted);
    border: 1.5px solid var(--border); border-radius: 14px; font-weight: 700; font-size: 15px;
    cursor: pointer; font-family: 'Noto Sans JP', sans-serif;
  }
  .btn-secondary {
    padding: 8px 16px; background: var(--bg); color: var(--ink);
    border: 1.5px solid var(--border); border-radius: 10px; font-weight: 700; font-size: 13px;
    cursor: pointer; font-family: 'Noto Sans JP', sans-serif;
  }

  /* Tag management section in form */
  .tag-manage-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
  .tag-manage-row input[type="text"] { flex: 1; margin-bottom: 0; }
  .color-swatches { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
  .swatch {
    width: 28px; height: 28px; border-radius: 50%; cursor: pointer;
    border: 2px solid transparent; transition: transform .15s;
  }
  .swatch.selected { border-color: var(--ink); transform: scale(1.15); }

  /* Tag list in settings */
  .tag-list-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 0; border-bottom: 1px solid var(--border);
  }
  .tag-dot { width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0; }
  .tag-list-name { flex: 1; font-size: 14px; font-weight: 500; }
  .tag-delete-btn {
    background: none; border: none; cursor: pointer; color: var(--ink-muted);
    font-size: 18px; padding: 2px 6px;
  }

  .divider { border: none; border-top: 1px solid var(--border); margin: 16px 0; }

  .loading-overlay {
    position: fixed; inset: 0; background: rgba(244,241,236,.7);
    display: flex; align-items: center; justify-content: center;
    z-index: 200; font-size: 14px; color: var(--ink-muted);
  }
  .toast {
    position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
    background: var(--ink); color: #fff; padding: 10px 20px; border-radius: 20px;
    font-size: 13px; z-index: 300; opacity: 0; transition: opacity .3s; pointer-events: none;
  }
  .toast.show { opacity: 1; }

  .priority-group-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; margin-top: 20px; }
</style>
</head>
<body>

<header>
  <div>
    <div class="header-sub">My Tasks</div>
    <div class="header-title" id="headerDate"></div>
  </div>
  <div class="view-tabs">
    <button class="view-tab active" onclick="setView('week')">ÈÄ±</button>
    <button class="view-tab" onclick="setView('list')">‰∏ÄË¶ß</button>
  </div>
</header>

<!-- Tag filter bar -->
<div class="filter-bar" id="filterBar"></div>

<main id="main"></main>

<button class="fab" onclick="openAdd()">Ôºã</button>

<!-- Task Modal -->
<div class="modal-overlay" id="taskModal" onclick="closeModal('taskModal', event)">
  <div class="modal">
    <div class="modal-title" id="taskModalTitle">„Çø„Çπ„ÇØ„ÇíËøΩÂä†</div>
    <label>„Çø„Çπ„ÇØÂêç</label>
    <input type="text" id="fName" placeholder="‰æãÔºö‰ºÅÁîªÊõ∏„Çí‰ΩúÊàê„Åô„Çã">
    <label>Á∑†„ÇÅÂàá„Çä</label>
    <input type="date" id="fDeadline">
    <label>ÂÑ™ÂÖàÂ∫¶</label>
    <div class="toggle-group" id="priorityGroup"></div>
    <label>ÈÄ≤Êçó</label>
    <div class="toggle-group" id="progressGroup"></div>
    <label>„Çø„Ç∞</label>
    <div class="tag-select-list" id="tagSelectList"></div>
    <div style="margin-bottom:16px">
      <button class="btn-secondary" onclick="openTagManager()">Ôºã „Çø„Ç∞„ÇíÁÆ°ÁêÜ„Åô„Çã</button>
    </div>
    <button class="btn-primary" onclick="submitTaskForm()">‰øùÂ≠ò„Åô„Çã</button>
    <button class="btn-danger" id="taskDeleteBtn" onclick="deleteTask()" style="display:none">ÂâäÈô§„Åô„Çã</button>
    <button class="btn-cancel" onclick="closeModal('taskModal')">„Ç≠„É£„É≥„Çª„É´</button>
  </div>
</div>

<!-- Tag Manager Modal -->
<div class="modal-overlay" id="tagModal" onclick="closeModal('tagModal', event)">
  <div class="modal">
    <div class="modal-title">„Çø„Ç∞„ÇíÁÆ°ÁêÜ</div>

    <label>Êñ∞„Åó„ÅÑ„Çø„Ç∞„ÇíËøΩÂä†</label>
    <div class="tag-manage-row">
      <input type="text" id="newTagName" placeholder="‰æãÔºöAÁ§æÊ°à‰ª∂">
    </div>
    <div class="color-swatches" id="colorSwatches"></div>
    <button class="btn-primary" onclick="submitNewTag()" style="margin-bottom:20px">„Çø„Ç∞„ÇíËøΩÂä†„Åô„Çã</button>

    <hr class="divider">
    <label>ÁôªÈå≤Ê∏à„Åø„Çø„Ç∞</label>
    <div id="tagListEl"></div>

    <button class="btn-cancel" onclick="closeModal('tagModal')" style="margin-top:16px">Èñâ„Åò„Çã</button>
  </div>
</div>

<div class="loading-overlay" id="loading">Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶</div>
<div class="toast" id="toast"></div>

<script>
const API = "https://script.google.com/macros/s/AKfycbw2c7dyUoDIzsRDV1bUYR_agcbvcW3er87NPOtW_gexjBjHOMwYr1iLhCECw7Tdx9sJWA/exec";

const PRIORITIES = ["È´ò","‰∏≠","‰Ωé"];
const PROGRESS   = ["Êú™ÁùÄÊâã","ÈÄ≤Ë°å‰∏≠","ÂÆå‰∫Ü"];
const P_COLOR  = { "È´ò":"#C84B31","‰∏≠":"#D97706","‰Ωé":"#4B7C59" };
const PR_COLOR = { "Êú™ÁùÄÊâã":"#A8A29E","ÈÄ≤Ë°å‰∏≠":"#2563EB","ÂÆå‰∫Ü":"#4B7C59" };
const DAY_LABELS = ["Êúà","ÁÅ´","Ê∞¥","Êú®","Èáë","Êó•"];
const TAG_COLORS = ["#E85D75","#E8913A","#D4B84A","#4CAF7D","#4A90D9","#7B68EE","#A0785A","#78716C"];

let tasks = [];
let tags  = [];
let currentView   = "week";
let filterTagId   = null; // null = ÂÖ®„Å¶
let editId        = null;
let fPriority     = "‰∏≠";
let fProgress     = "Êú™ÁùÄÊâã";
let fTagId        = "";
let newTagColor   = TAG_COLORS[0];

// ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function apiFetch(params) {
  const qs = new URLSearchParams(params).toString();
  const res = await fetch(API + "?" + qs);
  return res.json();
}
async function apiPost(body) {
  const res = await fetch(API, { method: "POST", body: JSON.stringify(body) });
  return res.json();
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
  document.getElementById("headerDate").textContent =
    (() => { const d = new Date(); return `${d.getFullYear()}Âπ¥${d.getMonth()+1}Êúà${d.getDate()}Êó•`; })();
  showLoading(true);
  try {
    const [t, g] = await Promise.all([apiFetch({action:"getAll"}), apiFetch({action:"getTags"})]);
    tasks = t.tasks || [];
    tags  = g.tags  || [];
  } catch(e) { showToast("Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"); }
  showLoading(false);
  renderFilterBar();
  render();
}

// ‚îÄ‚îÄ Filter bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderFilterBar() {
  const bar = document.getElementById("filterBar");
  bar.innerHTML = "";
  const all = document.createElement("button");
  all.className = "filter-chip" + (filterTagId === null ? " active" : "");
  if (filterTagId === null) { all.style.background = "#1C1917"; }
  all.textContent = "„Åô„Åπ„Å¶";
  all.onclick = () => { filterTagId = null; renderFilterBar(); render(); };
  bar.appendChild(all);

  tags.forEach(tag => {
    const chip = document.createElement("button");
    chip.className = "filter-chip" + (filterTagId === tag.id ? " active" : "");
    if (filterTagId === tag.id) chip.style.background = tag.color;
    chip.textContent = tag.name;
    chip.onclick = () => { filterTagId = tag.id; renderFilterBar(); render(); };
    bar.appendChild(chip);
  });
}

// ‚îÄ‚îÄ View ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setView(v) {
  currentView = v;
  document.querySelectorAll(".view-tab").forEach((b,i) => {
    b.classList.toggle("active", (i===0&&v==="week")||(i===1&&v==="list"));
  });
  render();
}

function filteredTasks() {
  if (filterTagId === null) return tasks;
  return tasks.filter(t => t.tagId === filterTagId);
}

function render() {
  const main = document.getElementById("main");
  main.innerHTML = "";
  if (currentView === "week") renderWeek(main);
  else renderList(main);
}

// ‚îÄ‚îÄ Week ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderWeek(container) {
  const today    = new Date();
  const weekDays = getWeekDays();
  const ft       = filteredTasks();

  const grid = document.createElement("div");
  grid.className = "week-grid";
  weekDays.forEach((day, i) => {
    const col   = document.createElement("div"); col.className = "day-col";
    const lbl   = document.createElement("div"); lbl.className = "day-label"+(i>=5?" weekend":""); lbl.textContent = DAY_LABELS[i];
    const num   = document.createElement("div"); num.className = "day-num"+(isSameDay(day,today)?" today":""); num.textContent = day.getDate();
    col.appendChild(lbl); col.appendChild(num);
    const dayTasks = tasks.filter(t => t.deadline && isSameDay(new Date(t.deadline), day)); // calendar shows all
    if (dayTasks.length) {
      const dots = document.createElement("div"); dots.className = "day-dots";
      dayTasks.forEach(t => {
        const dot = document.createElement("div"); dot.className = "day-dot";
        const tag = tags.find(g => g.id === t.tagId);
        dot.style.background = tag ? tag.color : (P_COLOR[t.priority]||"#888");
        dot.textContent = t.name; dot.onclick = () => openEdit(t);
        dots.appendChild(dot);
      });
      col.appendChild(dots);
    }
    grid.appendChild(col);
  });
  container.appendChild(grid);

  const active = ft.filter(t => t.progress !== "ÂÆå‰∫Ü")
    .sort((a,b) => PRIORITIES.indexOf(a.priority)-PRIORITIES.indexOf(b.priority));
  const done   = ft.filter(t => t.progress === "ÂÆå‰∫Ü");

  if (!active.length && !done.length) {
    container.appendChild(emptyEl("„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì")); return;
  }
  if (active.length) {
    container.appendChild(sectionLabel("ÈÄ≤Ë°å‰∏≠„ÅÆ„Çø„Çπ„ÇØ"));
    const list = document.createElement("div"); list.className = "task-list";
    active.forEach(t => list.appendChild(taskCard(t)));
    container.appendChild(list);
  }
  if (done.length) {
    container.appendChild(sectionLabel("ÂÆå‰∫ÜÊ∏à„Åø"));
    const list = document.createElement("div"); list.className = "task-list";
    done.forEach(t => list.appendChild(taskCard(t)));
    container.appendChild(list);
  }
}

// ‚îÄ‚îÄ List ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderList(container) {
  const ft     = filteredTasks();
  const active = ft.filter(t => t.progress !== "ÂÆå‰∫Ü");
  const done   = ft.filter(t => t.progress === "ÂÆå‰∫Ü");
  if (!ft.length) { container.appendChild(emptyEl("„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì")); return; }
  PRIORITIES.forEach(p => {
    const pt = active.filter(t => t.priority === p);
    if (!pt.length) return;
    const hdr = document.createElement("div"); hdr.className = "priority-group-header";
    const bdg = document.createElement("span"); bdg.className = "badge"; bdg.style.background = P_COLOR[p]; bdg.textContent = `ÂÑ™ÂÖàÂ∫¶Ôºö${p}`;
    hdr.appendChild(bdg); container.appendChild(hdr);
    const list = document.createElement("div"); list.className = "task-list";
    pt.forEach(t => list.appendChild(taskCard(t))); container.appendChild(list);
  });
  if (done.length) {
    container.appendChild(sectionLabel("ÂÆå‰∫ÜÊ∏à„Åø"));
    const list = document.createElement("div"); list.className = "task-list";
    done.forEach(t => list.appendChild(taskCard(t))); container.appendChild(list);
  }
}

// ‚îÄ‚îÄ Task card ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function taskCard(t) {
  const overdue = t.progress !== "ÂÆå‰∫Ü" && isOverdue(t.deadline);
  const card = document.createElement("div");
  card.className = "task-card"+(overdue?" overdue":"")+(t.progress==="ÂÆå‰∫Ü"?" done-card":"");

  const btn = document.createElement("button");
  btn.className = "progress-btn"; btn.style.background = PR_COLOR[t.progress]||"#ccc";
  btn.innerHTML = t.progress==="ÂÆå‰∫Ü"?"‚úì":t.progress==="ÈÄ≤Ë°å‰∏≠"?"‚ñ∂":"";
  btn.onclick = () => cycleProgress(t.id); card.appendChild(btn);

  const body = document.createElement("div"); body.className = "task-body";
  const name = document.createElement("div");
  name.className = "task-name"+(t.progress==="ÂÆå‰∫Ü"?" done-name":""); name.textContent = t.name;
  body.appendChild(name);

  const meta = document.createElement("div"); meta.className = "task-meta";
  const pbdg = document.createElement("span"); pbdg.className = "badge"; pbdg.style.background = P_COLOR[t.priority]||"#888"; pbdg.textContent = t.priority;
  meta.appendChild(pbdg);

  // Tag badge
  const tag = tags.find(g => g.id === t.tagId);
  if (tag) {
    const tbdg = document.createElement("span");
    tbdg.className = "tag-badge";
    tbdg.style.background = tag.color + "22";
    tbdg.style.color = tag.color;
    tbdg.style.border = `1px solid ${tag.color}55`;
    tbdg.textContent = tag.name;
    meta.appendChild(tbdg);
  }

  if (t.deadline) {
    const dl = document.createElement("span");
    dl.className = "deadline-text"+(overdue?" overdue":"");
    dl.textContent = (overdue?"‚ö† ":"")+formatDate(t.deadline);
    meta.appendChild(dl);
  }
  const pg = document.createElement("span"); pg.className = "progress-text"; pg.textContent = t.progress;
  meta.appendChild(pg);
  body.appendChild(meta); card.appendChild(body);

  const eb = document.createElement("button"); eb.className = "edit-btn"; eb.textContent = "‚Ä∫"; eb.onclick = () => openEdit(t);
  card.appendChild(eb);
  return card;
}

// ‚îÄ‚îÄ CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function cycleProgress(id) {
  const task = tasks.find(t => t.id === id); if (!task) return;
  const idx = PROGRESS.indexOf(task.progress);
  task.progress = PROGRESS[(idx+1)%PROGRESS.length];
  render();
  try { await apiPost({ action:"update", task }); showToast("Êõ¥Êñ∞„Åó„Åæ„Åó„Åü"); }
  catch { showToast("‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"); }
}

async function submitTaskForm() {
  const name = document.getElementById("fName").value.trim();
  if (!name) { showToast("„Çø„Çπ„ÇØÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }
  const task = { name, deadline: document.getElementById("fDeadline").value, priority: fPriority, progress: fProgress, tagId: fTagId };
  closeModal("taskModal");
  showLoading(true);
  try {
    if (editId) {
      task.id = editId;
      await apiPost({ action:"update", task });
      tasks = tasks.map(t => t.id===editId ? task : t);
      showToast("„Çø„Çπ„ÇØ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü");
    } else {
      const j = await apiPost({ action:"add", task });
      task.id = j.id; tasks.push(task);
      showToast("„Çø„Çπ„ÇØ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü");
    }
  } catch { showToast("‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"); }
  showLoading(false); render();
}

async function deleteTask() {
  if (!editId) return;
  closeModal("taskModal"); showLoading(true);
  try {
    await apiPost({ action:"delete", id: editId });
    tasks = tasks.filter(t => t.id !== editId);
    showToast("ÂâäÈô§„Åó„Åæ„Åó„Åü");
  } catch { showToast("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"); }
  showLoading(false); render();
}

// ‚îÄ‚îÄ Tag CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function submitNewTag() {
  const name = document.getElementById("newTagName").value.trim();
  if (!name) { showToast("„Çø„Ç∞Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }
  showLoading(true);
  try {
    const j = await apiPost({ action:"addTag", tag: { name, color: newTagColor } });
    tags.push({ id: j.id, name, color: newTagColor });
    document.getElementById("newTagName").value = "";
    renderTagList(); renderFilterBar(); buildTagSelect();
    showToast("„Çø„Ç∞„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü");
  } catch { showToast("‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"); }
  showLoading(false);
}

async function deleteTagById(id) {
  showLoading(true);
  try {
    await apiPost({ action:"deleteTag", id });
    tags = tags.filter(t => t.id !== id);
    // „Çø„Çπ„ÇØ„ÅÆ„Çø„Ç∞„ÇÇËß£Èô§
    tasks = tasks.map(t => t.tagId === id ? { ...t, tagId: "" } : t);
    if (filterTagId === id) filterTagId = null;
    renderTagList(); renderFilterBar(); buildTagSelect(); render();
    showToast("„Çø„Ç∞„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü");
  } catch { showToast("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"); }
  showLoading(false);
}

// ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openAdd() {
  editId = null; fPriority = "‰∏≠"; fProgress = "Êú™ÁùÄÊâã"; fTagId = "";
  document.getElementById("fName").value = "";
  document.getElementById("fDeadline").value = "";
  document.getElementById("taskModalTitle").textContent = "„Çø„Çπ„ÇØ„ÇíËøΩÂä†";
  document.getElementById("taskDeleteBtn").style.display = "none";
  buildToggles(); buildTagSelect();
  showModal("taskModal");
}

function openEdit(t) {
  editId = t.id; fPriority = t.priority; fProgress = t.progress; fTagId = t.tagId || "";
  document.getElementById("fName").value = t.name;
  document.getElementById("fDeadline").value = t.deadline || "";
  document.getElementById("taskModalTitle").textContent = "„Çø„Çπ„ÇØ„ÇíÁ∑®ÈõÜ";
  document.getElementById("taskDeleteBtn").style.display = "block";
  buildToggles(); buildTagSelect();
  showModal("taskModal");
}

function buildToggles() {
  const pg = document.getElementById("priorityGroup"); pg.innerHTML = "";
  PRIORITIES.forEach(p => {
    const b = document.createElement("button");
    b.className = "toggle-btn"+(fPriority===p?" selected":"");
    if (fPriority===p) b.style.background = P_COLOR[p];
    b.textContent = p; b.onclick = () => { fPriority=p; buildToggles(); };
    pg.appendChild(b);
  });
  const prg = document.getElementById("progressGroup"); prg.innerHTML = "";
  PROGRESS.forEach(p => {
    const b = document.createElement("button");
    b.className = "toggle-btn"+(fProgress===p?" selected":"");
    if (fProgress===p) b.style.background = PR_COLOR[p];
    b.textContent = p; b.onclick = () => { fProgress=p; buildToggles(); };
    prg.appendChild(b);
  });
}

function buildTagSelect() {
  const el = document.getElementById("tagSelectList"); el.innerHTML = "";
  // none
  const none = document.createElement("button");
  none.className = "tag-select-none"+(fTagId===""?" selected":"");
  none.textContent = "„Å™„Åó"; none.onclick = () => { fTagId=""; buildTagSelect(); };
  el.appendChild(none);
  tags.forEach(tag => {
    const b = document.createElement("button");
    b.className = "tag-select-item"+(fTagId===tag.id?" selected":"");
    if (fTagId===tag.id) b.style.background = tag.color;
    else { b.style.color = tag.color; b.style.borderColor = tag.color+"55"; b.style.background = tag.color+"11"; }
    b.textContent = tag.name; b.onclick = () => { fTagId=tag.id; buildTagSelect(); };
    el.appendChild(b);
  });
}

function openTagManager() {
  newTagColor = TAG_COLORS[0];
  buildColorSwatches(); renderTagList();
  showModal("tagModal");
}

function buildColorSwatches() {
  const el = document.getElementById("colorSwatches"); el.innerHTML = "";
  TAG_COLORS.forEach(c => {
    const s = document.createElement("div");
    s.className = "swatch"+(newTagColor===c?" selected":"");
    s.style.background = c;
    s.onclick = () => { newTagColor=c; buildColorSwatches(); };
    el.appendChild(s);
  });
}

function renderTagList() {
  const el = document.getElementById("tagListEl"); el.innerHTML = "";
  if (!tags.length) { el.innerHTML = '<div style="color:var(--ink-muted);font-size:13px;padding:8px 0">„Çø„Ç∞„Åå„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</div>'; return; }
  tags.forEach(tag => {
    const row = document.createElement("div"); row.className = "tag-list-item";
    const dot = document.createElement("div"); dot.className = "tag-dot"; dot.style.background = tag.color;
    const nm  = document.createElement("div"); nm.className = "tag-list-name"; nm.textContent = tag.name;
    const del = document.createElement("button"); del.className = "tag-delete-btn"; del.textContent = "√ó";
    del.onclick = () => { if(confirm(`„Äå${tag.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) deleteTagById(tag.id); };
    row.appendChild(dot); row.appendChild(nm); row.appendChild(del);
    el.appendChild(row);
  });
}

function showModal(id) {
  const el = document.getElementById(id);
  el.style.display = "flex";
  setTimeout(() => el.classList.add("open"), 10);
}

function closeModal(id, e) {
  if (e && e.target !== document.getElementById(id)) return;
  const el = document.getElementById(id);
  el.classList.remove("open");
  setTimeout(() => { el.style.display = "none"; }, 300);
  // „Çø„Ç∞ÁÆ°ÁêÜ„ÇíÈñâ„Åò„Åü„Çâ„Çø„Çπ„ÇØ„É¢„Éº„ÉÄ„É´„ÅÆ„Çø„Ç∞ÈÅ∏Êäû„ÇíÊõ¥Êñ∞
  if (id === "tagModal") buildTagSelect();
}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getWeekDays() {
  const today = new Date(); const day = today.getDay();
  const mon = new Date(today); mon.setDate(today.getDate()-(day===0?6:day-1));
  return Array.from({length:7},(_,i)=>{ const d=new Date(mon); d.setDate(mon.getDate()+i); return d; });
}
function isSameDay(d1,d2) { return d1.getFullYear()===d2.getFullYear()&&d1.getMonth()===d2.getMonth()&&d1.getDate()===d2.getDate(); }
function isOverdue(deadline) { if(!deadline) return false; const t=new Date(); t.setHours(0,0,0,0); return new Date(deadline)<t; }
function formatDate(d) { if(!d) return ""; const dt=new Date(d); return `${dt.getMonth()+1}/${dt.getDate()}`; }
function sectionLabel(text) { const el=document.createElement("div"); el.className="section-label"; el.textContent=text; return el; }
function emptyEl(text) { const el=document.createElement("div"); el.className="empty"; el.textContent=text; return el; }
function showLoading(v) { document.getElementById("loading").style.display=v?"flex":"none"; }
function showToast(msg) { const t=document.getElementById("toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),2000); }

init();
</script>
</body>
</html>
